<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nth Party Analysis Report - {{ summary.root_domain }}</title>
    <!-- XYFlow Svelte styles inlined -->
    <style>
.svelte-flow__zoom.svelte-4xkw84{width:100%;height:100%;position:absolute;top:0;left:0;z-index:4}.svelte-flow__pane.svelte-1esy7hx{position:absolute;top:0;left:0;width:100%;height:100%}.svelte-flow__viewport.svelte-1floaup{width:100%;height:100%;position:absolute;top:0;left:0}.svelte-flow__nodes.svelte-tf4uy4{width:100%;height:100%;position:absolute;left:0;top:0}.svelte-flow__selection.svelte-1iugwpu{position:absolute;top:0;left:0}.selection-wrapper.svelte-5pxri{position:absolute;top:0;left:0;z-index:7;pointer-events:all}.svelte-flow.svelte-18e9ir1{width:100%;height:100%;overflow:hidden;position:relative;z-index:0;background-color:var(--background-color, var(--background-color-default))}:root{--background-color-default:#fff;--background-pattern-color-default:#ddd;--minimap-mask-color-default:rgba(240, 240, 240, .6);--minimap-mask-stroke-color-default:none;--minimap-mask-stroke-width-default:1;--controls-button-background-color-default:#fefefe;--controls-button-background-color-hover-default:#f4f4f4;--controls-button-color-default:inherit;--controls-button-color-hover-default:inherit;--controls-button-border-color-default:#eee}.svelte-flow__background.svelte-1r7pe8d{position:absolute;width:100%;height:100%;top:0;left:0}.svelte-flow{direction:ltr;--xy-edge-stroke-default: #b1b1b7;--xy-edge-stroke-width-default: 1;--xy-edge-stroke-selected-default: #555;--xy-connectionline-stroke-default: #b1b1b7;--xy-connectionline-stroke-width-default: 1;--xy-attribution-background-color-default: rgba(255, 255, 255, .5);--xy-minimap-background-color-default: #fff;--xy-minimap-mask-background-color-default: rgba(240, 240, 240, .6);--xy-minimap-mask-stroke-color-default: transparent;--xy-minimap-mask-stroke-width-default: 1;--xy-minimap-node-background-color-default: #e2e2e2;--xy-minimap-node-stroke-color-default: transparent;--xy-minimap-node-stroke-width-default: 2;--xy-background-color-default: transparent;--xy-background-pattern-dots-color-default: #91919a;--xy-background-pattern-lines-color-default: #eee;--xy-background-pattern-cross-color-default: #e2e2e2;background-color:var(--xy-background-color, var(--xy-background-color-default));--xy-node-color-default: inherit;--xy-node-border-default: 1px solid #1a192b;--xy-node-background-color-default: #fff;--xy-node-group-background-color-default: rgba(240, 240, 240, .25);--xy-node-boxshadow-hover-default: 0 1px 4px 1px rgba(0, 0, 0, .08);--xy-node-boxshadow-selected-default: 0 0 0 .5px #1a192b;--xy-node-border-radius-default: 3px;--xy-handle-background-color-default: #1a192b;--xy-handle-border-color-default: #fff;--xy-selection-background-color-default: rgba(0, 89, 220, .08);--xy-selection-border-default: 1px dotted rgba(0, 89, 220, .8);--xy-controls-button-background-color-default: #fefefe;--xy-controls-button-background-color-hover-default: #f4f4f4;--xy-controls-button-color-default: inherit;--xy-controls-button-color-hover-default: inherit;--xy-controls-button-border-color-default: #eee;--xy-controls-box-shadow-default: 0 0 2px 1px rgba(0, 0, 0, .08);--xy-edge-label-background-color-default: #ffffff;--xy-edge-label-color-default: inherit;--xy-resize-background-color-default: #3367d9}.svelte-flow.dark{--xy-edge-stroke-default: #3e3e3e;--xy-edge-stroke-width-default: 1;--xy-edge-stroke-selected-default: #727272;--xy-connectionline-stroke-default: #b1b1b7;--xy-connectionline-stroke-width-default: 1;--xy-attribution-background-color-default: rgba(150, 150, 150, .25);--xy-minimap-background-color-default: #141414;--xy-minimap-mask-background-color-default: rgba(60, 60, 60, .6);--xy-minimap-mask-stroke-color-default: transparent;--xy-minimap-mask-stroke-width-default: 1;--xy-minimap-node-background-color-default: #2b2b2b;--xy-minimap-node-stroke-color-default: transparent;--xy-minimap-node-stroke-width-default: 2;--xy-background-color-default: #141414;--xy-background-pattern-dots-color-default: #777;--xy-background-pattern-lines-color-default: #777;--xy-background-pattern-cross-color-default: #777;--xy-node-color-default: #f8f8f8;--xy-node-border-default: 1px solid #3c3c3c;--xy-node-background-color-default: #1e1e1e;--xy-node-group-background-color-default: rgba(240, 240, 240, .25);--xy-node-boxshadow-hover-default: 0 1px 4px 1px rgba(255, 255, 255, .08);--xy-node-boxshadow-selected-default: 0 0 0 .5px #999;--xy-handle-background-color-default: #bebebe;--xy-handle-border-color-default: #1e1e1e;--xy-selection-background-color-default: rgba(200, 200, 220, .08);--xy-selection-border-default: 1px dotted rgba(200, 200, 220, .8);--xy-controls-button-background-color-default: #2b2b2b;--xy-controls-button-background-color-hover-default: #3e3e3e;--xy-controls-button-color-default: #f8f8f8;--xy-controls-button-color-hover-default: #fff;--xy-controls-button-border-color-default: #5b5b5b;--xy-controls-box-shadow-default: 0 0 2px 1px rgba(0, 0, 0, .08);--xy-edge-label-background-color-default: #141414;--xy-edge-label-color-default: #f8f8f8}.svelte-flow__background{background-color:var(--xy-background-color, var(--xy-background-color-props, var(--xy-background-color-default)));pointer-events:none;z-index:-1}.svelte-flow__container{position:absolute;width:100%;height:100%;top:0;left:0}.svelte-flow__pane{z-index:1}.svelte-flow__pane.draggable{cursor:grab}.svelte-flow__pane.dragging{cursor:grabbing}.svelte-flow__pane.selection{cursor:pointer}.svelte-flow__viewport{transform-origin:0 0;z-index:2;pointer-events:none}.svelte-flow__renderer{z-index:4}.svelte-flow__selection{z-index:6}.svelte-flow__nodesselection-rect:focus,.svelte-flow__nodesselection-rect:focus-visible{outline:none}.svelte-flow__edge-path{stroke:var(--xy-edge-stroke, var(--xy-edge-stroke-default));stroke-width:var(--xy-edge-stroke-width, var(--xy-edge-stroke-width-default));fill:none}.svelte-flow__connection-path{stroke:var(--xy-connectionline-stroke, var(--xy-connectionline-stroke-default));stroke-width:var(--xy-connectionline-stroke-width, var(--xy-connectionline-stroke-width-default));fill:none}.svelte-flow .svelte-flow__edges{position:absolute}.svelte-flow .svelte-flow__edges svg{overflow:visible;position:absolute;pointer-events:none}.svelte-flow__edge{pointer-events:visibleStroke}.svelte-flow__edge.selectable{cursor:pointer}.svelte-flow__edge.animated path{stroke-dasharray:5;animation:dashdraw .5s linear infinite}.svelte-flow__edge.animated path.svelte-flow__edge-interaction{stroke-dasharray:none;animation:none}.svelte-flow__edge.inactive{pointer-events:none}.svelte-flow__edge.selected,.svelte-flow__edge:focus,.svelte-flow__edge:focus-visible{outline:none}.svelte-flow__edge.selected .svelte-flow__edge-path,.svelte-flow__edge.selectable:focus .svelte-flow__edge-path,.svelte-flow__edge.selectable:focus-visible .svelte-flow__edge-path{stroke:var(--xy-edge-stroke-selected, var(--xy-edge-stroke-selected-default))}.svelte-flow__edge-textwrapper{pointer-events:all}.svelte-flow__edge .svelte-flow__edge-text{pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.svelte-flow__connection{pointer-events:none}.svelte-flow__connection .animated{stroke-dasharray:5;animation:dashdraw .5s linear infinite}svg.svelte-flow__connectionline{z-index:1001;overflow:visible;position:absolute}.svelte-flow__nodes{pointer-events:none;transform-origin:0 0}.svelte-flow__node{position:absolute;-webkit-user-select:none;-moz-user-select:none;user-select:none;pointer-events:all;transform-origin:0 0;box-sizing:border-box;cursor:default}.svelte-flow__node.selectable{cursor:pointer}.svelte-flow__node.draggable{cursor:grab;pointer-events:all}.svelte-flow__node.draggable.dragging{cursor:grabbing}.svelte-flow__nodesselection{z-index:3;transform-origin:left top;pointer-events:none}.svelte-flow__nodesselection-rect{position:absolute;pointer-events:all;cursor:grab}.svelte-flow__handle{position:absolute;pointer-events:none;min-width:5px;min-height:5px;width:6px;height:6px;background-color:var(--xy-handle-background-color, var(--xy-handle-background-color-default));border:1px solid var(--xy-handle-border-color, var(--xy-handle-border-color-default));border-radius:100%}.svelte-flow__handle.connectingfrom{pointer-events:all}.svelte-flow__handle.connectionindicator{pointer-events:all;cursor:crosshair}.svelte-flow__handle-bottom{top:auto;left:50%;bottom:0;transform:translate(-50%,50%)}.svelte-flow__handle-top{top:0;left:50%;transform:translate(-50%,-50%)}.svelte-flow__handle-left{top:50%;left:0;transform:translate(-50%,-50%)}.svelte-flow__handle-right{top:50%;right:0;transform:translate(50%,-50%)}.svelte-flow__edgeupdater{cursor:move;pointer-events:all}.svelte-flow__panel{position:absolute;z-index:5;margin:15px}.svelte-flow__panel.top{top:0}.svelte-flow__panel.bottom{bottom:0}.svelte-flow__panel.top.center,.svelte-flow__panel.bottom.center{left:50%;transform:translate(-15px) translate(-50%)}.svelte-flow__panel.left{left:0}.svelte-flow__panel.right{right:0}.svelte-flow__panel.left.center,.svelte-flow__panel.right.center{top:50%;transform:translateY(-15px) translateY(-50%)}.svelte-flow__attribution{font-size:10px;background:var(--xy-attribution-background-color, var(--xy-attribution-background-color-default));padding:2px 3px;margin:0}.svelte-flow__attribution a{text-decoration:none;color:#999}@keyframes dashdraw{0%{stroke-dashoffset:10}}.svelte-flow__edgelabel-renderer{position:absolute;width:100%;height:100%;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;left:0;top:0}.svelte-flow__viewport-portal{position:absolute;width:100%;height:100%;left:0;top:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.svelte-flow__minimap{background:var( --xy-minimap-background-color-props, var(--xy-minimap-background-color, var(--xy-minimap-background-color-default)) )}.svelte-flow__minimap-svg{display:block}.svelte-flow__minimap-mask{fill:var( --xy-minimap-mask-background-color-props, var(--xy-minimap-mask-background-color, var(--xy-minimap-mask-background-color-default)) );stroke:var( --xy-minimap-mask-stroke-color-props, var(--xy-minimap-mask-stroke-color, var(--xy-minimap-mask-stroke-color-default)) );stroke-width:var( --xy-minimap-mask-stroke-width-props, var(--xy-minimap-mask-stroke-width, var(--xy-minimap-mask-stroke-width-default)) )}.svelte-flow__minimap-node{fill:var( --xy-minimap-node-background-color-props, var(--xy-minimap-node-background-color, var(--xy-minimap-node-background-color-default)) );stroke:var( --xy-minimap-node-stroke-color-props, var(--xy-minimap-node-stroke-color, var(--xy-minimap-node-stroke-color-default)) );stroke-width:var( --xy-minimap-node-stroke-width-props, var(--xy-minimap-node-stroke-width, var(--xy-minimap-node-stroke-width-default)) )}.svelte-flow__background-pattern.dots{fill:var( --xy-background-pattern-color-props, var(--xy-background-pattern-color, var(--xy-background-pattern-dots-color-default)) )}.svelte-flow__background-pattern.lines{stroke:var( --xy-background-pattern-color-props, var(--xy-background-pattern-color, var(--xy-background-pattern-lines-color-default)) )}.svelte-flow__background-pattern.cross{stroke:var( --xy-background-pattern-color-props, var(--xy-background-pattern-color, var(--xy-background-pattern-cross-color-default)) )}.svelte-flow__controls{display:flex;flex-direction:column;box-shadow:var(--xy-controls-box-shadow, var(--xy-controls-box-shadow-default))}.svelte-flow__controls.horizontal{flex-direction:row}.svelte-flow__controls-button{display:flex;justify-content:center;align-items:center;height:26px;width:26px;padding:4px;border:none;background:var(--xy-controls-button-background-color, var(--xy-controls-button-background-color-default));border-bottom:1px solid var( --xy-controls-button-border-color-props, var(--xy-controls-button-border-color, var(--xy-controls-button-border-color-default)) );color:var( --xy-controls-button-color-props, var(--xy-controls-button-color, var(--xy-controls-button-color-default)) );cursor:pointer;-webkit-user-select:none;-moz-user-select:none;user-select:none}.svelte-flow__controls-button svg{width:100%;max-width:12px;max-height:12px;fill:currentColor}.svelte-flow__edge.updating .svelte-flow__edge-path{stroke:#777}.svelte-flow__edge-text{font-size:10px}.svelte-flow__node.selectable:focus,.svelte-flow__node.selectable:focus-visible{outline:none}.svelte-flow__node-input,.svelte-flow__node-default,.svelte-flow__node-output,.svelte-flow__node-group{padding:10px;border-radius:var(--xy-node-border-radius, var(--xy-node-border-radius-default));width:150px;font-size:12px;color:var(--xy-node-color, var(--xy-node-color-default));text-align:center;border:var(--xy-node-border, var(--xy-node-border-default));background-color:var(--xy-node-background-color, var(--xy-node-background-color-default))}.svelte-flow__node-input.selectable:hover,.svelte-flow__node-default.selectable:hover,.svelte-flow__node-output.selectable:hover,.svelte-flow__node-group.selectable:hover{box-shadow:var(--xy-node-boxshadow-hover, var(--xy-node-boxshadow-hover-default))}.svelte-flow__node-input.selectable.selected,.svelte-flow__node-input.selectable:focus,.svelte-flow__node-input.selectable:focus-visible,.svelte-flow__node-default.selectable.selected,.svelte-flow__node-default.selectable:focus,.svelte-flow__node-default.selectable:focus-visible,.svelte-flow__node-output.selectable.selected,.svelte-flow__node-output.selectable:focus,.svelte-flow__node-output.selectable:focus-visible,.svelte-flow__node-group.selectable.selected,.svelte-flow__node-group.selectable:focus,.svelte-flow__node-group.selectable:focus-visible{box-shadow:var(--xy-node-boxshadow-selected, var(--xy-node-boxshadow-selected-default))}.svelte-flow__node-group{background-color:var(--xy-node-group-background-color, var(--xy-node-group-background-color-default))}.svelte-flow__nodesselection-rect,.svelte-flow__selection{background:var(--xy-selection-background-color, var(--xy-selection-background-color-default));border:var(--xy-selection-border, var(--xy-selection-border-default))}.svelte-flow__nodesselection-rect:focus,.svelte-flow__nodesselection-rect:focus-visible,.svelte-flow__selection:focus,.svelte-flow__selection:focus-visible{outline:none}.svelte-flow__controls-button:hover{background:var( --xy-controls-button-background-color-hover-props, var(--xy-controls-button-background-color-hover, var(--xy-controls-button-background-color-hover-default)) );color:var( --xy-controls-button-color-hover-props, var(--xy-controls-button-color-hover, var(--xy-controls-button-color-hover-default)) )}.svelte-flow__controls-button:disabled{pointer-events:none}.svelte-flow__controls-button:disabled svg{fill-opacity:.4}.svelte-flow__controls-button:last-child{border-bottom:none}.svelte-flow__controls.horizontal .svelte-flow__controls-button{border-bottom:none;border-right:1px solid var( --xy-controls-button-border-color-props, var(--xy-controls-button-border-color, var(--xy-controls-button-border-color-default)) )}.svelte-flow__controls.horizontal .svelte-flow__controls-button:last-child{border-right:none}.svelte-flow__resize-control{position:absolute}.svelte-flow__resize-control.left,.svelte-flow__resize-control.right{cursor:ew-resize}.svelte-flow__resize-control.top,.svelte-flow__resize-control.bottom{cursor:ns-resize}.svelte-flow__resize-control.top.left,.svelte-flow__resize-control.bottom.right{cursor:nwse-resize}.svelte-flow__resize-control.bottom.left,.svelte-flow__resize-control.top.right{cursor:nesw-resize}.svelte-flow__resize-control.handle{width:4px;height:4px;border:1px solid #fff;border-radius:1px;background-color:var(--xy-resize-background-color, var(--xy-resize-background-color-default));transform:translate(-50%,-50%)}.svelte-flow__resize-control.handle.left{left:0;top:50%}.svelte-flow__resize-control.handle.right{left:100%;top:50%}.svelte-flow__resize-control.handle.top{left:50%;top:0}.svelte-flow__resize-control.handle.bottom{left:50%;top:100%}.svelte-flow__resize-control.handle.top.left,.svelte-flow__resize-control.handle.bottom.left{left:0}.svelte-flow__resize-control.handle.top.right,.svelte-flow__resize-control.handle.bottom.right{left:100%}.svelte-flow__resize-control.line{border-color:var(--xy-resize-background-color, var(--xy-resize-background-color-default));border-width:0;border-style:solid}.svelte-flow__resize-control.line.left,.svelte-flow__resize-control.line.right{width:1px;transform:translate(-50%);top:0;height:100%}.svelte-flow__resize-control.line.left{left:0;border-left-width:1px}.svelte-flow__resize-control.line.right{left:100%;border-right-width:1px}.svelte-flow__resize-control.line.top,.svelte-flow__resize-control.line.bottom{height:1px;transform:translateY(-50%);left:0;width:100%}.svelte-flow__resize-control.line.top{top:0;border-top-width:1px}.svelte-flow__resize-control.line.bottom{border-bottom-width:1px;top:100%}.svelte-flow__edge-label{text-align:center;position:absolute;padding:2px;font-size:10px;cursor:pointer;color:var(--xy-edge-label-color, var(--xy-edge-label-color-default));background:var(--xy-edge-label-background-color, var(--xy-edge-label-background-color-default))}.svelte-flow__nodes,.svelte-flow__edgelabel-renderer{z-index:0}.root-node.svelte-tkgxpd{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:16px 20px;border-radius:12px;min-width:180px;box-shadow:0 4px 12px #6366f14d;cursor:pointer;transition:transform .2s,box-shadow .2s;display:flex;align-items:center;gap:12px}.root-node.svelte-tkgxpd:hover{transform:translateY(-2px);box-shadow:0 6px 16px #6366f166}.root-node.expanded.svelte-tkgxpd{box-shadow:0 4px 12px #6366f166}.node-icon.svelte-tkgxpd{font-size:24px}.node-content.svelte-tkgxpd{flex:1}.node-domain.svelte-tkgxpd{font-weight:600;font-size:14px;margin-bottom:2px}.node-org.svelte-tkgxpd{font-size:11px;opacity:.9}.node-children.svelte-tkgxpd{font-size:11px;opacity:.8;margin-top:4px}.vendor-node.svelte-1mswpjf{color:#fff;padding:12px 16px;border-radius:10px;min-width:140px;box-shadow:0 3px 10px var(--shadow-color, rgba(0,0,0,.2));cursor:pointer;transition:transform .2s,box-shadow .2s}.vendor-node.svelte-1mswpjf:hover{transform:translateY(-2px);box-shadow:0 5px 14px var(--shadow-color, rgba(0,0,0,.3))}.vendor-node.has-children.svelte-1mswpjf{cursor:pointer}.vendor-node.expanded.svelte-1mswpjf{box-shadow:0 4px 12px var(--shadow-color, rgba(0,0,0,.3))}.node-content.svelte-1mswpjf{text-align:center}.node-domain.svelte-1mswpjf{font-weight:600;font-size:13px;margin-bottom:2px;word-break:break-all}.node-org.svelte-1mswpjf{font-size:10px;opacity:.9;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.node-children.svelte-1mswpjf{font-size:10px;opacity:.8;margin-top:4px}.load-more-node.svelte-aq22t1{background:#fff;border:2px dashed #9ca3af;color:#6b7280;padding:10px 14px;border-radius:8px;min-width:100px;cursor:pointer;transition:all .2s}.load-more-node.svelte-aq22t1:hover{border-color:#6366f1;color:#6366f1;background:#f5f3ff}.node-content.svelte-aq22t1{text-align:center}.node-icon.svelte-aq22t1{font-size:18px;font-weight:700;margin-bottom:2px}.node-label.svelte-aq22t1{font-size:12px;font-weight:500}.node-hint.svelte-aq22t1{font-size:9px;opacity:.7;margin-top:2px}.vendor-graph-container.svelte-19rw5s4{width:100%;height:100%;position:relative}.graph-controls.svelte-19rw5s4{position:absolute;top:10px;left:10px;z-index:10;display:flex;gap:8px}.btn.svelte-19rw5s4{padding:8px 16px;border-radius:6px;border:none;cursor:pointer;font-size:14px;font-weight:500;transition:background-color .2s}.btn-primary.svelte-19rw5s4{background-color:#6366f1;color:#fff}.btn-primary.svelte-19rw5s4:hover{background-color:#4f46e5}.btn-secondary.svelte-19rw5s4{background-color:#e5e7eb;color:#374151}.btn-secondary.svelte-19rw5s4:hover{background-color:#d1d5db}.svelte-flow{background-color:#fafafa}
    </style>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #1f2937;
            --dark-bg-secondary: #374151;
            --light-bg: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--light-bg);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .header .domain-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .section {
            background: white;
            margin-bottom: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            background: var(--primary-color);
            color: white;
            padding: 1.5rem;
            position: relative;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .section-description {
            opacity: 0.9;
        }

        .section-content {
            padding: 2rem;
        }

        .graph-container {
            height: 600px;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            background: white;
            position: relative;
        }

        .graph-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--light-bg);
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .data-table th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .data-table th:hover {
            background: var(--border-color);
        }

        .data-table th.sortable::after {
            content: ' ‚ÜïÔ∏è';
            opacity: 0.5;
        }

        .data-table th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        .data-table th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        .data-table tbody tr:hover {
            background: var(--light-bg);
        }

        .data-table td code {
            max-width: 300px;
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }

        .data-table td code:hover {
            max-width: none;
            white-space: normal;
            word-break: break-all;
        }

        .data-table td strong {
            cursor: pointer;
            color: var(--primary-color);
            transition: color 0.2s ease;
        }

        .data-table td strong:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .layer-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }

        .layer-1 { background: var(--success-color); }
        .layer-2 { background: var(--warning-color); }
        .layer-3 { background: var(--danger-color); }
        .layer-4 { background: var(--dark-bg); }
        .layer-default { background: var(--text-secondary); }

        .record-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }

        .record-type-DNS\:\:TXT\:\:SPF { background: #8b5cf6; }
        .record-type-DNS\:\:TXT\:\:VERIFICATION { background: #06b6d4; }
        .record-type-DNS\:\:TXT\:\:DMARC { background: #ec4899; }
        .record-type-DNS\:\:SUBDOMAIN { background: #f97316; }
        .record-type-DNS\:\:CNAME { background: #14b8a6; }
        .record-type-HTTP\:\:SUBPROCESSOR { background: #dc2626; }
        .record-type-DISCOVERY\:\:SUBFINDER { background: #a855f7; }
        .record-type-DISCOVERY\:\:SAAS_TENANT { background: #eab308; }
        .record-type-default { background: var(--text-secondary); }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
        }
        
        .expandable-hint {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            z-index: 100;
        }

        .footer {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            .graph-container {
                height: 400px;
            }
            
            .filters {
                flex-direction: column;
            }
        }

        .tooltip {
            position: absolute;
            background: var(--dark-bg);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        .table-loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .table-container {
            position: relative;
        }

        .filter-result-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-bg);
            border-radius: 0.25rem;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-bg);
            border-radius: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0 1rem;
        }

        .pagination-select {
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        .export-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .export-btn:hover {
            background: #059669;
        }

        .table-toolbar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .table-toolbar .search-box {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }

        /* Evidence Modal Styles */
        .evidence-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .evidence-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .evidence-modal {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
        }

        .evidence-modal-overlay.active .evidence-modal {
            transform: scale(1) translateY(0);
        }

        .evidence-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 1rem 1rem 0 0;
            color: white;
        }

        .evidence-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .evidence-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background 0.2s ease;
        }

        .evidence-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .evidence-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .evidence-section {
            margin-bottom: 1.5rem;
        }

        .evidence-section:last-child {
            margin-bottom: 0;
        }

        .evidence-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .evidence-content {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .evidence-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .evidence-meta-item {
            background: var(--light-bg);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--primary-color);
        }

        .evidence-meta-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .evidence-meta-value {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 0.25rem;
        }

        /* Validation Commands Section */
        .validation-section {
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .validation-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .validation-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .validation-tab:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .validation-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .validation-tab-icon {
            font-size: 1rem;
        }

        .validation-command-container {
            background: #1f2937;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .validation-command-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .validation-command-label {
            color: #9ca3af;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .validation-copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #9ca3af;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .validation-copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .validation-copy-btn.copied {
            background: var(--success-color);
            color: white;
        }

        .validation-command-code {
            padding: 1rem;
            color: #e5e7eb;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .validation-explanation {
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #93c5fd;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .validation-explanation code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        /* Evidence Cell Buttons */
        .evidence-cell {
            text-align: center;
        }

        .evidence-preview {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .evidence-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .evidence-btn-reveal {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .evidence-btn-reveal:hover {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }


        /* Run in Browser Section */
        .browser-validation {
            margin-top: 1rem;
            padding: 1rem;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 0.5rem;
        }

        .browser-validation-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .browser-validation-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 0.5rem;
        }

        .browser-validation-btn:hover {
            background: #d97706;
        }

        .browser-validation-result {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .browser-validation-code {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #1f2937;
            border-radius: 0.375rem;
            color: #e5e7eb;
            font-family: monospace;
            font-size: 0.75rem;
            display: none;
        }

        .browser-validation-code.visible {
            display: block;
        }

        .inspect-code-btn {
            background: transparent;
            border: 1px solid #d97706;
            color: #92400e;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .inspect-code-btn:hover {
            background: #fef3c7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Nth Party Analysis Report</h1>
            <div class="subtitle">Vendor Relationship Discovery & Risk Assessment</div>
            <div class="domain-info">
                <strong>{{ summary.root_domain }}</strong> ({{ summary.root_organization }})
                <div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.8;">
                    Generated on {{ summary.generated_at }}
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ summary.total_relationships }}</div>
                <div class="stat-label">Total Relationships</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ summary.max_depth }}</div>
                <div class="stat-label">Maximum Depth</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ summary.unique_domains }}</div>
                <div class="stat-label">Unique Domains</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ summary.unique_organizations }}</div>
                <div class="stat-label">Unique Organizations</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-title">üìà Analysis Insights</div>
                <div class="section-description">Key findings from vendor relationship analysis</div>
            </div>
            <div class="section-content" id="insights-section">
                <p class="loading">Analyzing relationships...</p>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-title">üåê Interactive Vendor Relationship Graph</div>
                <div class="section-description">Click on nodes to expand and explore vendor relationships. Drag to pan, scroll to zoom.</div>
            </div>
            <div class="section-content">
                <!-- XYFlow Svelte graph container - controls are built-in -->
                <div id="vendor-graph" class="graph-container" style="height: 600px;">
                    <div class="loading" id="graph-loading">
                        <div class="spinner"></div>
                        Loading graph visualization...
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        Root Domain
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3b82f6;"></div>
                        3rd Party Vendor
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f59e0b;"></div>
                        4th Party Vendor
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444;"></div>
                        5th+ Party Vendor
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-title">üìä Vendor Relationships Data</div>
                <div class="section-description">Sortable and searchable table of all discovered vendor relationships</div>
            </div>
            <div class="section-content">
                <div class="tabs" role="tablist" aria-label="Data view tabs">
                    <button class="tab active" role="tab" aria-selected="true" aria-controls="all-tab" id="tab-all" onclick="showTab('all', event)" onkeydown="handleTabKeydown(event, 'all')">All Relationships</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="summary-tab" id="tab-summary" onclick="showTab('summary', event)" onkeydown="handleTabKeydown(event, 'summary')">Summary by Organization</button>
                </div>

                <div id="all-tab" class="tab-content active" role="tabpanel" aria-labelledby="tab-all">
                    <input type="text" class="search-box" id="search-all" placeholder="Search all relationships..." aria-label="Search all relationships" onkeyup="applyFilters('all-table')">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Layer:</label>
                            <select class="filter-select" id="filter-layer-all" onchange="applyFilters('all-table')">
                                <option value="">All Layers</option>
                                {% for layer in 1..=summary.max_depth %}
                                <option value="{{ layer }}">Layer {{ layer }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Discovery Source:</label>
                            <select class="filter-select" id="filter-type-all" onchange="applyFilters('all-table')">
                                <option value="">All Sources</option>
                                <option value="DNS::TXT::SPF">Email Provider (SPF)</option>
                                <option value="DNS::TXT::VERIFICATION">Domain Verification</option>
                                <option value="DNS::SUBDOMAIN">Subdomain</option>
                                <option value="DNS::CNAME">CNAME Record</option>
                                <option value="HTTP::SUBPROCESSOR">Subprocessor Page</option>
                                <option value="DISCOVERY::SUBFINDER">Subdomain Discovery</option>
                                <option value="DISCOVERY::SAAS_TENANT">SaaS Tenant</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="all-table">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('all-table', 0)">Vendor Domain</th>
                                    <th class="sortable" onclick="sortTable('all-table', 1)">Organization</th>
                                    <th class="sortable" onclick="sortTable('all-table', 2)">Layer</th>
                                    <th class="sortable" onclick="sortTable('all-table', 3)">Discovery Source</th>
                                    <th class="sortable" onclick="sortTable('all-table', 4)">Customer</th>
                                    <th class="sortable" onclick="sortTable('all-table', 5)">Record Value</th>
                                    <th class="sortable" onclick="sortTable('all-table', 6)">Evidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rel in relationships %}
                                <tr data-layer="{{ rel.nth_party_layer }}" data-type="{{ rel.nth_party_record_type.as_hierarchy_string() }}">
                                    <td><strong>{{ rel.nth_party_domain }}</strong></td>
                                    <td>{{ rel.nth_party_organization }}</td>
                                    <td><span class="layer-badge layer-{{ rel.nth_party_layer }}">Layer {{ rel.nth_party_layer }}</span></td>
                                    <td><span class="record-type-badge record-type-{{ rel.nth_party_record_type.as_hierarchy_string() }}">{{ rel.nth_party_record_type.as_hierarchy_string() }}</span></td>
                                    <td>{{ rel.nth_party_customer_domain }}</td>
                                    <td><code>{{ rel.nth_party_record }}</code></td>
                                    <td class="evidence-cell">
                                        <button class="evidence-btn evidence-btn-reveal" onclick="openEvidenceModal({{ loop.index0 }})" title="View full evidence">üëÅ Show</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="summary-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-summary">
                    <input type="text" class="search-box" id="search-summary" placeholder="Search organizations..." aria-label="Search organizations" onkeyup="filterTable('summary-table', this.value)">
                    <div class="table-container">
                        <table class="data-table" id="summary-table">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('summary-table', 0)">Organization</th>
                                    <th class="sortable" onclick="sortTable('summary-table', 1)">Total Relationships</th>
                                    <th class="sortable" onclick="sortTable('summary-table', 2)">Deepest Layer</th>
                                    <th class="sortable" onclick="sortTable('summary-table', 3)">Record Types</th>
                                    <th class="sortable" onclick="sortTable('summary-table', 4)">Domains</th>
                                </tr>
                            </thead>
                            <tbody id="summary-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Report generated by <strong>nthpartyfinder</strong> - A tool for discovering vendor relationships through DNS analysis</p>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Data from Rust - exposed as window.graphData for Svelte bundle
        window.graphData = {
            relationships: {{ relationships_json|safe }},
            summary: {{ summary_json|safe }}
        };
        // Legacy aliases for table JavaScript
        const relationshipsData = window.graphData.relationships;
        const summary = window.graphData.summary;

        let currentSortColumn = {};

        // Loading state management
        function initializeLoadingOverlays() {
            document.querySelectorAll('.table-container').forEach(container => {
                if (!container.querySelector('.table-loading-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'table-loading-overlay';
                    overlay.innerHTML = '<div class="spinner"></div><span>Processing...</span>';
                    container.appendChild(overlay);
                }
            });
        }

        function showTableLoading(tableId) {
            const table = document.getElementById(tableId);
            if (table) {
                const container = table.closest('.table-container');
                if (container) {
                    const overlay = container.querySelector('.table-loading-overlay');
                    if (overlay) overlay.classList.add('active');
                }
            }
        }

        function hideTableLoading(tableId) {
            const table = document.getElementById(tableId);
            if (table) {
                const container = table.closest('.table-container');
                if (container) {
                    const overlay = container.querySelector('.table-loading-overlay');
                    if (overlay) overlay.classList.remove('active');
                }
            }
        }

        function updateFilterCount(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');
            const visibleCount = Array.from(rows).filter(r => r.style.display !== 'none').length;
            const totalCount = rows.length;

            const container = table.closest('.table-container');
            let countEl = container.parentElement.querySelector('.filter-result-count');

            if (visibleCount < totalCount) {
                if (!countEl) {
                    countEl = document.createElement('div');
                    countEl.className = 'filter-result-count';
                    container.parentElement.insertBefore(countEl, container.nextSibling);
                }
                countEl.textContent = `Showing ${visibleCount} of ${totalCount} results`;
            } else if (countEl) {
                countEl.remove();
            }
        }

        // Pagination system
        const paginationState = {};
        const DEFAULT_PAGE_SIZE = 50;

        function initializePagination(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');
            const totalRows = rows.length;

            // Only paginate if more than page size
            if (totalRows <= DEFAULT_PAGE_SIZE) return;

            paginationState[tableId] = {
                currentPage: 1,
                pageSize: DEFAULT_PAGE_SIZE,
                totalRows: totalRows
            };

            createPaginationControls(tableId);
            applyPagination(tableId);
        }

        function createPaginationControls(tableId) {
            const table = document.getElementById(tableId);
            const container = table.closest('.table-container');
            const parent = container.parentElement;

            // Remove existing pagination if present
            const existingPagination = parent.querySelector('.pagination');
            if (existingPagination) existingPagination.remove();

            const state = paginationState[tableId];
            const totalPages = Math.ceil(state.totalRows / state.pageSize);

            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination';
            paginationDiv.id = `pagination-${tableId}`;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '‚Üê Previous';
            prevBtn.onclick = () => goToPage(tableId, state.currentPage - 1);
            paginationDiv.appendChild(prevBtn);

            // Page numbers
            const pageNumbers = document.createElement('span');
            pageNumbers.className = 'pagination-info';
            pageNumbers.id = `page-info-${tableId}`;
            paginationDiv.appendChild(pageNumbers);

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = 'Next ‚Üí';
            nextBtn.onclick = () => goToPage(tableId, state.currentPage + 1);
            paginationDiv.appendChild(nextBtn);

            // Page size selector
            const sizeLabel = document.createElement('span');
            sizeLabel.className = 'pagination-info';
            sizeLabel.textContent = ' | Rows per page:';
            paginationDiv.appendChild(sizeLabel);

            const sizeSelect = document.createElement('select');
            sizeSelect.className = 'pagination-select';
            [25, 50, 100, 200].forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                if (size === state.pageSize) option.selected = true;
                sizeSelect.appendChild(option);
            });
            sizeSelect.onchange = (e) => changePageSize(tableId, parseInt(e.target.value));
            paginationDiv.appendChild(sizeSelect);

            parent.appendChild(paginationDiv);
            updatePaginationControls(tableId);
        }

        function updatePaginationControls(tableId) {
            const state = paginationState[tableId];
            if (!state) return;

            const paginationDiv = document.getElementById(`pagination-${tableId}`);
            if (!paginationDiv) return;

            const totalPages = Math.ceil(state.totalRows / state.pageSize);
            const buttons = paginationDiv.querySelectorAll('.pagination-btn');
            const pageInfo = document.getElementById(`page-info-${tableId}`);

            // Update prev/next buttons
            if (buttons[0]) buttons[0].disabled = state.currentPage <= 1;
            if (buttons[1]) buttons[1].disabled = state.currentPage >= totalPages;

            // Update page info
            if (pageInfo) {
                const start = (state.currentPage - 1) * state.pageSize + 1;
                const end = Math.min(state.currentPage * state.pageSize, state.totalRows);
                pageInfo.textContent = `Page ${state.currentPage} of ${totalPages} (${start}-${end} of ${state.totalRows})`;
            }
        }

        function goToPage(tableId, page) {
            const state = paginationState[tableId];
            if (!state) return;

            const totalPages = Math.ceil(state.totalRows / state.pageSize);
            if (page < 1 || page > totalPages) return;

            state.currentPage = page;
            applyPagination(tableId);
            updatePaginationControls(tableId);
        }

        function changePageSize(tableId, newSize) {
            const state = paginationState[tableId];
            if (!state) return;

            state.pageSize = newSize;
            state.currentPage = 1;
            applyPagination(tableId);
            updatePaginationControls(tableId);
        }

        function applyPagination(tableId) {
            const state = paginationState[tableId];
            if (!state) return;

            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');

            const start = (state.currentPage - 1) * state.pageSize;
            const end = start + state.pageSize;

            rows.forEach((row, index) => {
                // Only apply pagination to rows not hidden by filters
                if (row.getAttribute('data-filtered-out') === 'true') {
                    row.style.display = 'none';
                } else {
                    row.style.display = (index >= start && index < end) ? '' : 'none';
                }
            });
        }

        // CSV Export functionality
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const rows = [];

            // Get headers
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(escapeCSVField(th.textContent.trim().replace(/[‚ÜïÔ∏è‚Üë‚Üì]/g, '').trim()));
            });
            rows.push(headers.join(','));

            // Get visible data rows
            table.querySelectorAll('tbody tr').forEach(tr => {
                // Skip hidden rows (filtered out)
                if (tr.style.display === 'none') return;

                const cells = [];
                tr.querySelectorAll('td').forEach(td => {
                    cells.push(escapeCSVField(td.textContent.trim()));
                });
                rows.push(cells.join(','));
            });

            // Create and download the CSV
            const csvContent = rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename || 'export.csv');
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function escapeCSVField(field) {
            if (field === null || field === undefined) return '';
            const str = String(field);
            // If contains comma, quote, or newline, wrap in quotes and escape quotes
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function addExportButton(tableId, tabId, exportFilename) {
            const tab = document.getElementById(tabId);
            if (!tab) return;

            const searchBox = tab.querySelector('.search-box');
            if (!searchBox) return;

            // Create toolbar wrapper if it doesn't exist
            let toolbar = tab.querySelector('.table-toolbar');
            if (!toolbar) {
                toolbar = document.createElement('div');
                toolbar.className = 'table-toolbar';
                searchBox.parentNode.insertBefore(toolbar, searchBox);
                toolbar.appendChild(searchBox);
            }

            // Add export button
            const exportBtn = document.createElement('button');
            exportBtn.className = 'export-btn';
            exportBtn.innerHTML = 'üì• Export CSV';
            exportBtn.onclick = () => exportTableToCSV(tableId, exportFilename);
            toolbar.appendChild(exportBtn);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Hide graph loading indicator (Svelte handles its own loading)
            const graphLoading = document.getElementById('graph-loading');
            if (graphLoading) graphLoading.style.display = 'none';

            initializeLoadingOverlays();
            generateInsights();
            // Graph initialization is handled by Svelte bundle
            generateSummaryTable();
            setupTableInteractions();
            convertRecordTypeBadges();

            // Initialize pagination for large tables
            initializePagination('all-table');
            initializePagination('summary-table');

            // Add export buttons to each tab
            addExportButton('all-table', 'all-tab', 'all-relationships.csv');
            addExportButton('summary-table', 'summary-tab', 'organization-summary.csv');
        });

        function convertRecordTypeBadges() {
            document.querySelectorAll('.record-type-badge').forEach(badge => {
                const rawType = badge.textContent.trim();
                badge.textContent = getReadableRecordType(rawType);
            });
        }

        function generateInsights() {
            const insightsContainer = document.getElementById('insights-section');
            insightsContainer.textContent = '';

            // Calculate statistics
            const orgCounts = {};
            const vendorsByLayer = {};
            const spfVendors = [];
            const verificationVendors = [];
            const subprocessorVendors = [];

            relationshipsData.forEach(rel => {
                orgCounts[rel.nth_party_organization] = (orgCounts[rel.nth_party_organization] || 0) + 1;
                vendorsByLayer[rel.nth_party_layer] = (vendorsByLayer[rel.nth_party_layer] || 0) + 1;

                // Check for both enum variant names (DnsTxtSpf) and hierarchy strings (DNS::TXT::SPF)
                const recordType = rel.nth_party_record_type;
                if (recordType === 'DnsTxtSpf' || recordType === 'DNS::TXT::SPF') {
                    spfVendors.push(rel.nth_party_domain);
                } else if (recordType === 'DnsTxtVerification' || recordType === 'DNS::TXT::VERIFICATION') {
                    verificationVendors.push(rel.nth_party_domain);
                } else if (recordType === 'HttpSubprocessor' || recordType === 'HTTP::SUBPROCESSOR') {
                    subprocessorVendors.push(rel.nth_party_domain);
                }
            });

            // Find most common vendor
            const mostCommonVendor = Object.entries(orgCounts).sort((a, b) => b[1] - a[1])[0];

            // Find deepest chain
            const deepestLayer = Math.max(...Object.keys(vendorsByLayer).map(Number));

            // Create insights
            const insightsGrid = document.createElement('div');
            insightsGrid.style.display = 'grid';
            insightsGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(250px, 1fr))';
            insightsGrid.style.gap = '1rem';

            const insights = [
                {
                    icon: 'üèÜ',
                    title: 'Most Common Vendor',
                    value: mostCommonVendor ? mostCommonVendor[0] : 'N/A',
                    subtitle: mostCommonVendor ? `${mostCommonVendor[1]} relationships` : ''
                },
                {
                    icon: 'üîó',
                    title: 'Deepest Vendor Chain',
                    value: `${deepestLayer} layers`,
                    subtitle: `${vendorsByLayer[deepestLayer] || 0} vendors at this depth`
                },
                {
                    icon: 'üìß',
                    title: 'Email Service Providers',
                    value: new Set(spfVendors).size,
                    subtitle: 'Unique SPF domains'
                },
                {
                    icon: '‚úÖ',
                    title: 'Verified Services',
                    value: new Set(verificationVendors).size,
                    subtitle: 'Domain verifications'
                }
            ];

            if (subprocessorVendors.length > 0) {
                insights.push({
                    icon: 'üîÑ',
                    title: 'Subprocessors',
                    value: new Set(subprocessorVendors).size,
                    subtitle: 'From subprocessor pages'
                });
            }

            insights.forEach(insight => {
                const card = document.createElement('div');
                card.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
                card.style.padding = '1.5rem';
                card.style.borderRadius = '0.5rem';
                card.style.borderLeft = '4px solid var(--primary-color)';

                const iconDiv = document.createElement('div');
                iconDiv.style.fontSize = '2rem';
                iconDiv.style.marginBottom = '0.5rem';
                iconDiv.textContent = insight.icon;

                const titleDiv = document.createElement('div');
                titleDiv.style.fontSize = '0.875rem';
                titleDiv.style.color = 'var(--text-secondary)';
                titleDiv.style.fontWeight = '500';
                titleDiv.style.marginBottom = '0.25rem';
                titleDiv.textContent = insight.title;

                const valueDiv = document.createElement('div');
                valueDiv.style.fontSize = '1.5rem';
                valueDiv.style.fontWeight = '700';
                valueDiv.style.color = 'var(--primary-color)';
                valueDiv.style.marginBottom = '0.25rem';
                valueDiv.textContent = insight.value;

                const subtitleDiv = document.createElement('div');
                subtitleDiv.style.fontSize = '0.75rem';
                subtitleDiv.style.color = 'var(--text-secondary)';
                subtitleDiv.textContent = insight.subtitle;

                card.appendChild(iconDiv);
                card.appendChild(titleDiv);
                card.appendChild(valueDiv);
                card.appendChild(subtitleDiv);

                insightsGrid.appendChild(card);
            });

            insightsContainer.appendChild(insightsGrid);
        }

        function initializeGraph() {
            const container = document.getElementById('network-graph');
            const loadingIndicator = container.querySelector('.loading');
            
            try {
                console.log('Starting graph initialization...');
                console.log('relationshipsData:', relationshipsData ? relationshipsData.length : 'undefined');
                console.log('summary:', summary);
                
                // Check if vis is loaded with multiple attempts
                if (typeof vis === 'undefined') {
                    console.error('vis.js library not loaded, attempting fallback...');
                    
                    // Try loading from different CDNs
                    const cdnUrls = [
                        'https://cdn.jsdelivr.net/npm/vis-network@9.1.9/dist/vis-network.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js',
                        'https://unpkg.com/vis@4.21.0/dist/vis.min.js'
                    ];
                    
                    let attempts = 0;
                    function tryLoadVis() {
                        if (attempts >= cdnUrls.length) {
                            loadingIndicator.innerHTML = '<div style="color: orange; text-align: center; padding: 2rem;"><h3>üìä Network Visualization Unavailable</h3><p>The interactive graph requires an internet connection to load the visualization library.</p><p style="margin-top: 1rem;"><strong>Don\'t worry!</strong> All the data is still available in the sortable tables below.</p><button class="btn btn-primary" onclick="location.reload()" style="margin-top: 1rem;">üîÑ Try Again</button></div>';
                            return;
                        }
                        
                        loadingIndicator.innerHTML = '<div class="spinner"></div>Loading visualization library... (attempt ' + (attempts + 1) + ')';
                        
                        const script = document.createElement('script');
                        script.src = cdnUrls[attempts];
                        script.onload = function() {
                            console.log('vis.js loaded from:', cdnUrls[attempts]);
                            setTimeout(initializeGraph, 100); // Retry initialization
                        };
                        script.onerror = function() {
                            attempts++;
                            setTimeout(tryLoadVis, 1000); // Try next CDN after 1 second
                        };
                        document.head.appendChild(script);
                    }
                    
                    tryLoadVis();
                    return;
                }

                // Check if data is available
                if (!relationshipsData || !summary) {
                    console.error('Data not available');
                    loadingIndicator.innerHTML = '<div style="color: red;">Error: Data not available</div>';
                    return;
                }

                console.log('Initializing graph with', relationshipsData.length, 'relationships');
                
                // Prepare nodes and edges datasets
                console.log('Creating data structures...');
                window.allNodes = new vis.DataSet();
                window.allEdges = new vis.DataSet();
                window.visibleNodes = new vis.DataSet();
                window.visibleEdges = new vis.DataSet();
                window.expandedNodes = new Set();

                // Per-layer vendor display limits (defaults: layer 1 = 100, layer 2 = 10, layer 3+ = 5)
                window.LAYER_LIMITS = { 1: 100, 2: 10, 3: 5, default: 5 };

                // Track how many vendors are currently shown per parent node
                // Key: parentId, Value: { shown: number, total: number }
                window.vendorVisibility = {};

                console.log('Data structures created successfully');
                
                // Store all relationship data organized by parent
                window.relationshipsByParent = {};
                relationshipsData.forEach(function(rel) {
                    if (!window.relationshipsByParent[rel.nth_party_customer_domain]) {
                        window.relationshipsByParent[rel.nth_party_customer_domain] = [];
                    }
                    window.relationshipsByParent[rel.nth_party_customer_domain].push(rel);
                });
                
                // Add root node
                const rootChildCount = window.relationshipsByParent[summary.root_domain] ? window.relationshipsByParent[summary.root_domain].length : 0;
                const rootNode = {
                    id: summary.root_domain,
                    label: summary.root_domain + '\n(' + summary.root_organization + ')' + (rootChildCount > 0 ? '\n‚ñº ' + rootChildCount + ' vendors' : ''),
                    group: 'root',
                    level: 0,
                    title: 'Root Domain: ' + summary.root_domain + '<br>Organization: ' + summary.root_organization + (rootChildCount > 0 ? '<br><br>Click to expand ' + rootChildCount + ' vendors ‚ñº' : ''),
                    hasChildren: rootChildCount > 0,
                    expanded: false
                };
                
                window.allNodes.add(rootNode);
                window.visibleNodes.add(rootNode);
                console.log('Root node created:', rootNode.id, 'with', rootChildCount, 'children');
                
                // Build complete node and edge datasets (but don't show them yet)
                const addedNodes = new Set([summary.root_domain]);
                
                relationshipsData.forEach(function(rel, index) {
                    // Add vendor node if not already added
                    if (!addedNodes.has(rel.nth_party_domain)) {
                        // Count only direct children of this node (consistent with expand logic)
                        const directChildren = relationshipsData.filter(function(r) {
                            return r.nth_party_customer_domain === rel.nth_party_domain;
                        });
                        const childCount = directChildren.length;
                        const hasChildren = childCount > 0;
                        const nodeData = {
                            id: rel.nth_party_domain,
                            label: rel.nth_party_domain + '\n(' + rel.nth_party_organization + ')' + (hasChildren ? '\n‚ñº ' + childCount + ' vendors' : ''),
                            group: 'layer' + rel.nth_party_layer,
                            level: rel.nth_party_layer,
                            title: 'Domain: ' + rel.nth_party_domain + '<br>Organization: ' + rel.nth_party_organization + '<br>Layer: ' + rel.nth_party_layer + (hasChildren ? '<br><br>Click to expand ' + childCount + ' vendors ‚ñº' : ''),
                            hasChildren: hasChildren,
                            expanded: false
                        };
                        window.allNodes.add(nodeData);
                        addedNodes.add(rel.nth_party_domain);
                    }
                    
                    // Add customer node if not already added and it's not the root
                    if (!addedNodes.has(rel.nth_party_customer_domain) && rel.nth_party_customer_domain !== summary.root_domain) {
                        const customerLevel = rel.nth_party_layer - 1;
                        const hasChildren = !!(window.relationshipsByParent[rel.nth_party_customer_domain] && window.relationshipsByParent[rel.nth_party_customer_domain].length > 0);
                        const nodeData = {
                            id: rel.nth_party_customer_domain,
                            label: rel.nth_party_customer_domain,
                            group: customerLevel === 0 ? 'root' : 'layer' + customerLevel,
                            level: customerLevel,
                            title: 'Customer Domain: ' + rel.nth_party_customer_domain + (hasChildren ? '<br><br>Click to expand vendors ‚ñº' : ''),
                            hasChildren: hasChildren,
                            expanded: false
                        };
                        window.allNodes.add(nodeData);
                        addedNodes.add(rel.nth_party_customer_domain);
                    }
                    
                    // Add edge to complete dataset with unique ID including index
                    window.allEdges.add({
                        id: rel.nth_party_customer_domain + '->' + rel.nth_party_domain + '-' + rel.nth_party_record_type + '-' + index,
                        from: rel.nth_party_customer_domain,
                        to: rel.nth_party_domain,
                        label: rel.nth_party_record_type,
                        color: getEdgeColor(rel.nth_party_record_type),
                        title: rel.nth_party_record_type + ': ' + rel.nth_party_record,
                        arrows: 'to',
                        layer: rel.nth_party_layer
                    });
                });
                
                const data = { nodes: window.visibleNodes, edges: window.visibleEdges };
                
                const options = {
                    groups: {
                        root: { color: { background: '#10b981', border: '#047857' }, font: { color: 'white' } },
                        layer1: { color: { background: '#3b82f6', border: '#1d4ed8' }, font: { color: 'white' } },
                        layer2: { color: { background: '#f59e0b', border: '#d97706' }, font: { color: 'white' } },
                        layer3: { color: { background: '#ef4444', border: '#dc2626' }, font: { color: 'white' } },
                        layer4: { color: { background: '#6b7280', border: '#374151' }, font: { color: 'white' } },
                        loadMore: {
                            color: { background: '#8b5cf6', border: '#7c3aed' },
                            font: { color: 'white' },
                            shape: 'ellipse',
                            borderWidth: 3,
                            borderDashes: [5, 5]
                        }
                    },
                    nodes: {
                        shape: 'box',
                        margin: { top: 10, right: 10, bottom: 10, left: 10 },
                        widthConstraint: { minimum: 120, maximum: 250 },
                        heightConstraint: { minimum: 40 },
                        font: { 
                            size: 11, 
                            face: 'Arial, sans-serif',
                            color: 'white',
                            strokeWidth: 1,
                            strokeColor: 'rgba(0,0,0,0.3)'
                        },
                        borderWidth: 2,
                        shadow: { enabled: true, size: 3, x: 2, y: 2 },
                        chosen: {
                            node: function(values, id, selected, hovering) {
                                if (hovering) {
                                    values.shadow = true;
                                    values.shadowSize = 8;
                                    values.shadowX = 3;
                                    values.shadowY = 3;
                                }
                            }
                        }
                    },
                    edges: {
                        font: { 
                            size: 9, 
                            strokeWidth: 3, 
                            strokeColor: 'white',
                            face: 'Arial, sans-serif'
                        },
                        arrows: { to: { enabled: true, scaleFactor: 0.8 } },
                        smooth: { 
                            enabled: true, 
                            type: 'cubicBezier',
                            forceDirection: 'vertical',
                            roundness: 0.4
                        },
                        width: 2,
                        selectionWidth: 4,
                        hoverWidth: 3,
                        shadow: { enabled: false }
                    },
                    physics: {
                        enabled: true,
                        hierarchicalRepulsion: {
                            centralGravity: 0.1,
                            springLength: 200,
                            springConstant: 0.005,
                            nodeDistance: 150,
                            damping: 0.3
                        },
                        maxVelocity: 30,
                        minVelocity: 0.1,
                        solver: 'hierarchicalRepulsion',
                        stabilization: {
                            enabled: true,
                            iterations: 100,
                            updateInterval: 25
                        }
                    },
                    layout: {
                        hierarchical: {
                            enabled: true,
                            levelSeparation: 200,
                            nodeSpacing: 150,
                            treeSpacing: 300,
                            blockShifting: true,
                            edgeMinimization: true,
                            parentCentralization: true,
                            direction: 'UD', // Top-Down for better readability
                            sortMethod: 'directed',
                            shakeTowards: 'leaves'
                        }
                    },
                    interaction: {
                        dragNodes: true,
                        dragView: true,
                        zoomView: true
                    }
                };
                
                network = new vis.Network(container, data, options);
                
                // Add event handlers
                network.on('click', function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        expandOrCollapseNode(nodeId);
                    }
                });

                network.on('stabilizationProgress', function(params) {
                    const progress = Math.round((params.iterations / params.total) * 100);
                    loadingIndicator.innerHTML = '<div class="spinner"></div>Layouting graph... ' + progress + '%';
                });

                network.on('stabilizationIterationsDone', function() {
                    console.log('Graph stabilization complete');
                    loadingIndicator.style.display = 'none';
                });
                
                console.log('Graph initialized successfully');
                console.log('Total nodes:', window.allNodes.length, 'Visible nodes:', window.visibleNodes.length);
                console.log('Total edges:', window.allEdges.length, 'Visible edges:', window.visibleEdges.length);
                
            } catch (error) {
                console.error('Error initializing graph:', error);
                console.error('Stack trace:', error.stack);
                loadingIndicator.innerHTML = '<div style="color: red;">Error loading graph: ' + error.message + '</div>';
            }
        }
        
        function getEdgeColor(recordType) {
            switch (recordType) {
                case 'DnsTxtSpf':
                case 'DNS::TXT::SPF':
                    return '#8b5cf6';
                case 'DnsTxtVerification':
                case 'DNS::TXT::VERIFICATION':
                    return '#06b6d4';
                case 'DnsSubdomain':
                case 'DNS::SUBDOMAIN':
                    return '#f97316';
                case 'DnsCname':
                case 'DNS::CNAME':
                    return '#14b8a6';
                case 'HttpSubprocessor':
                case 'HTTP::SUBPROCESSOR':
                    return '#22c55e';
                case 'SubfinderDiscovery':
                case 'DISCOVERY::SUBFINDER':
                    return '#a855f7';
                case 'SaasTenantProbe':
                case 'DISCOVERY::SAAS_TENANT':
                    return '#eab308';
                default:
                    return '#6b7280';
            }
        }
        
        function expandOrCollapseNode(nodeId) {
            // Hide the hint on first interaction
            const hint = document.getElementById('graph-hint');
            if (hint) {
                hint.style.display = 'none';
            }

            const node = window.allNodes.get(nodeId);
            if (!node) {
                return;
            }

            // Handle "load more" node clicks
            if (node.isLoadMore) {
                loadMoreVendors(nodeId);
                return;
            }

            if (!node.hasChildren) {
                // If no children, just focus on the node
                network.focus(nodeId, { animation: true });
                return;
            }

            if (window.expandedNodes.has(nodeId)) {
                // Collapse node
                collapseNode(nodeId);
            } else {
                // Expand node
                expandNode(nodeId);
            }
        }
        
        function getLayerLimit(layer) {
            return window.LAYER_LIMITS[layer] || window.LAYER_LIMITS.default;
        }

        function getLoadMoreNodeId(parentId) {
            return 'loadMore_' + parentId;
        }

        function createOrUpdateLoadMoreNode(parentId, remainingCount, layer) {
            const loadMoreId = getLoadMoreNodeId(parentId);
            const existingNode = window.allNodes.get(loadMoreId);

            if (remainingCount <= 0) {
                // Remove load more node if no more vendors to show
                if (existingNode) {
                    window.allNodes.remove(loadMoreId);
                    window.visibleNodes.remove(loadMoreId);
                    // Remove the edge to load more node
                    const edgeId = parentId + '->loadMore';
                    window.allEdges.remove(edgeId);
                    window.visibleEdges.remove(edgeId);
                }
                return;
            }

            const layerLimit = getLayerLimit(layer);
            const nodeData = {
                id: loadMoreId,
                label: '+ ' + remainingCount + ' more\nvendors',
                group: 'loadMore',
                level: layer,
                title: 'Click to load ' + Math.min(remainingCount, layerLimit) + ' more vendors<br>(Layer ' + layer + ', ' + remainingCount + ' total remaining)',
                hasChildren: false,
                expanded: false,
                isLoadMore: true,
                parentId: parentId,
                remainingCount: remainingCount
            };

            if (existingNode) {
                window.allNodes.update(nodeData);
                if (window.visibleNodes.get(loadMoreId)) {
                    window.visibleNodes.update(nodeData);
                }
            } else {
                window.allNodes.add(nodeData);
                window.visibleNodes.add(nodeData);

                // Add edge from parent to load more node
                const edgeData = {
                    id: parentId + '->loadMore',
                    from: parentId,
                    to: loadMoreId,
                    color: { color: '#8b5cf6', opacity: 0.6 },
                    dashes: true,
                    arrows: 'to',
                    width: 1,
                    layer: layer
                };
                window.allEdges.add(edgeData);
                window.visibleEdges.add(edgeData);
            }
        }

        function expandNode(nodeId) {
            console.log('Expanding node:', nodeId);
            const relationships = window.relationshipsByParent[nodeId] || [];

            // Filter to show ONLY direct children (where this nodeId is the immediate parent)
            const directChildren = relationships.filter(function(rel) {
                return rel.nth_party_customer_domain === nodeId;
            });

            const totalChildren = directChildren.length;
            console.log(`Found ${totalChildren} direct children for ${nodeId}`);

            // Determine the layer for children (parent layer + 1, or 1 if root)
            const parentNode = window.allNodes.get(nodeId);
            const childLayer = (parentNode && parentNode.level !== undefined) ? parentNode.level + 1 : 1;
            const layerLimit = getLayerLimit(childLayer);

            // Initialize visibility tracking for this parent if not exists
            if (!window.vendorVisibility[nodeId]) {
                window.vendorVisibility[nodeId] = { shown: 0, total: totalChildren };
            }

            const visibility = window.vendorVisibility[nodeId];
            const startIndex = visibility.shown;
            const endIndex = Math.min(startIndex + layerLimit, totalChildren);
            const vendorsToShow = directChildren.slice(startIndex, endIndex);

            console.log(`Showing vendors ${startIndex} to ${endIndex - 1} (limit: ${layerLimit} for layer ${childLayer})`);

            // Show limited vendors
            vendorsToShow.forEach(function(rel) {
                // Add vendor node if not already visible
                const vendorNode = window.allNodes.get(rel.nth_party_domain);
                if (vendorNode && !window.visibleNodes.get(rel.nth_party_domain)) {
                    console.log(`Adding direct child: ${rel.nth_party_domain}`);
                    window.visibleNodes.add(vendorNode);
                }

                // Add edge if not already visible - need to find edge with matching from/to
                const matchingEdges = window.allEdges.get().filter(function(edge) {
                    return edge.from === rel.nth_party_customer_domain && edge.to === rel.nth_party_domain;
                });
                matchingEdges.forEach(function(edge) {
                    if (!window.visibleEdges.get(edge.id)) {
                        window.visibleEdges.add(edge);
                    }
                });
            });

            // Update visibility tracking
            visibility.shown = endIndex;

            // Create or update "load more" collapsed node if there are remaining vendors
            const remainingCount = totalChildren - visibility.shown;
            createOrUpdateLoadMoreNode(nodeId, remainingCount, childLayer);

            // Mark as expanded and update node appearance with better indicator
            window.expandedNodes.add(nodeId);
            const node = window.allNodes.get(nodeId);
            const shownText = visibility.shown < totalChildren
                ? `[${visibility.shown}/${totalChildren} vendors]`
                : `[${totalChildren} vendors]`;
            const updatedNode = {
                ...node,
                title: node.title.replace('Click to expand vendors ‚ñº', `Click to collapse ${totalChildren} vendors ‚ñ≤`),
                expanded: true,
                label: node.label.includes('[') ? node.label.replace(/\[.*vendors\]/, shownText) : node.label + `\n${shownText}`
            };
            window.allNodes.update(updatedNode);
            window.visibleNodes.update(updatedNode);

            // Fit the view to show new nodes
            setTimeout(function() {
                network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
            }, 100);
        }

        function loadMoreVendors(loadMoreNodeId) {
            const loadMoreNode = window.allNodes.get(loadMoreNodeId);
            if (!loadMoreNode || !loadMoreNode.isLoadMore) {
                return;
            }

            const parentId = loadMoreNode.parentId;
            console.log('Loading more vendors for parent:', parentId);

            // Remove the current load more node from visible set (will be recreated if needed)
            window.visibleNodes.remove(loadMoreNodeId);
            window.visibleEdges.remove(parentId + '->loadMore');

            // Expand will add more vendors and recreate load more node if needed
            expandNode(parentId);
        }
        
        function collapseNode(nodeId) {
            console.log('Collapsing node:', nodeId);
            const relationships = window.relationshipsByParent[nodeId] || [];

            // Collect nodes to hide (and their descendants)
            const nodesToHide = new Set();
            const edgesToHide = new Set();

            function collectDescendants(parentId) {
                const childRelationships = window.relationshipsByParent[parentId] || [];
                // Filter to get only direct children of this parent
                const directChildren = childRelationships.filter(function(rel) {
                    return rel.nth_party_customer_domain === parentId;
                });

                directChildren.forEach(function(rel) {
                    nodesToHide.add(rel.nth_party_domain);

                    // Find all edges that go to this domain and mark them for hiding
                    const matchingEdges = window.allEdges.get().filter(function(edge) {
                        return edge.from === rel.nth_party_customer_domain && edge.to === rel.nth_party_domain;
                    });
                    matchingEdges.forEach(function(edge) {
                        edgesToHide.add(edge.id);
                    });

                    // Recursively collect descendants if the child is also expanded
                    if (window.expandedNodes.has(rel.nth_party_domain)) {
                        collectDescendants(rel.nth_party_domain);
                        window.expandedNodes.delete(rel.nth_party_domain);
                        // Reset visibility tracking for descendant
                        delete window.vendorVisibility[rel.nth_party_domain];
                    }
                });

                // Also collect "load more" node for this parent if it exists
                const loadMoreId = getLoadMoreNodeId(parentId);
                if (window.allNodes.get(loadMoreId)) {
                    nodesToHide.add(loadMoreId);
                    edgesToHide.add(parentId + '->loadMore');
                    // Remove from allNodes as well since it's dynamic
                    window.allNodes.remove(loadMoreId);
                    window.allEdges.remove(parentId + '->loadMore');
                }
            }

            collectDescendants(nodeId);

            // Remove nodes and edges from visible sets
            window.visibleNodes.remove(Array.from(nodesToHide));
            window.visibleEdges.remove(Array.from(edgesToHide));

            // Reset visibility tracking for this node
            delete window.vendorVisibility[nodeId];

            // Mark as collapsed and update node appearance
            window.expandedNodes.delete(nodeId);
            const node = window.allNodes.get(nodeId);
            // Count only direct children
            const directChildren = relationships.filter(function(rel) {
                return rel.nth_party_customer_domain === nodeId;
            });
            const childCount = directChildren.length;
            // Remove any vendor count text from label (handles both [X vendors] and [X/Y vendors] formats)
            const cleanLabel = node.label.replace(/\n\[[\d\/]+ vendors\]/, '');
            const updatedNode = {
                ...node,
                title: node.title.replace(`Click to collapse ${childCount} vendors ‚ñ≤`, 'Click to expand vendors ‚ñº'),
                expanded: false,
                label: cleanLabel
            };
            window.allNodes.update(updatedNode);
            window.visibleNodes.update(updatedNode);

            // Stabilize the network
            network.stabilize();
        }
        
        function resetGraph() {
            network.fit({ animation: true });
            network.unselectAll();
        }
        
        function expandAll() {
            console.log('Expanding all nodes...');
            // Get all nodes that have children but are not expanded
            const nodesToExpand = window.allNodes.get().filter(function(node) {
                return node.hasChildren && !window.expandedNodes.has(node.id);
            });
            
            nodesToExpand.forEach(function(node) {
                expandNode(node.id);
            });
            
            setTimeout(function() {
                network.fit({ animation: true });
            }, 1000);
        }
        
        function collapseAll() {
            console.log('Collapsing all nodes...');
            // Start from root and collapse everything
            const expandedNodesList = Array.from(window.expandedNodes);
            expandedNodesList.forEach(function(nodeId) {
                if (nodeId === summary.root_domain) {
                    collapseNode(nodeId);
                }
            });
            
            setTimeout(function() {
                network.fit({ animation: true });
            }, 1000);
        }
        
        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            network.setOptions({ physics: { enabled: physicsEnabled } });
        }
        
        function exportGraph() {
            const canvas = network.canvas.frame.canvas;
            const link = document.createElement('a');
            link.download = summary.root_domain + '_vendor_graph.png';
            link.href = canvas.toDataURL();
            link.click();
        }
        
        function generateSummaryTable() {
            const orgSummary = {};

            relationshipsData.forEach(rel => {
                if (!orgSummary[rel.nth_party_organization]) {
                    orgSummary[rel.nth_party_organization] = {
                        count: 0,
                        maxLayer: 0,
                        recordTypes: new Set(),
                        domains: new Set()
                    };
                }

                orgSummary[rel.nth_party_organization].count++;
                orgSummary[rel.nth_party_organization].maxLayer = Math.max(
                    orgSummary[rel.nth_party_organization].maxLayer,
                    rel.nth_party_layer
                );
                orgSummary[rel.nth_party_organization].recordTypes.add(rel.nth_party_record_type);
                orgSummary[rel.nth_party_organization].domains.add(rel.nth_party_domain);
            });

            const tbody = document.getElementById('summary-tbody');
            tbody.textContent = '';

            // Sort by count descending
            const sortedEntries = Object.entries(orgSummary).sort((a, b) => b[1].count - a[1].count);

            sortedEntries.forEach(([org, data]) => {
                const row = document.createElement('tr');

                // Organization cell
                const orgCell = document.createElement('td');
                const orgStrong = document.createElement('strong');
                orgStrong.textContent = org;
                orgCell.appendChild(orgStrong);
                row.appendChild(orgCell);

                // Count cell
                const countCell = document.createElement('td');
                countCell.textContent = data.count;
                row.appendChild(countCell);

                // Layer cell
                const layerCell = document.createElement('td');
                const layerBadge = document.createElement('span');
                layerBadge.className = `layer-badge layer-${data.maxLayer}`;
                layerBadge.textContent = `Layer ${data.maxLayer}`;
                layerCell.appendChild(layerBadge);
                row.appendChild(layerCell);

                // Record types cell
                const typesCell = document.createElement('td');
                Array.from(data.recordTypes).forEach(type => {
                    const typeBadge = document.createElement('span');
                    typeBadge.className = `record-type-badge record-type-${type}`;
                    typeBadge.textContent = type;
                    typesCell.appendChild(typeBadge);
                    typesCell.appendChild(document.createTextNode(' '));
                });
                row.appendChild(typesCell);

                // Domains cell
                const domainsCell = document.createElement('td');
                domainsCell.textContent = Array.from(data.domains).join(', ');
                row.appendChild(domainsCell);

                tbody.appendChild(row);
            });
        }
        
        const TAB_ORDER = ['all', 'spf', 'verification', 'subprocessors', 'summary'];

        function showTab(tabName, event) {
            // Hide all tabs and update ARIA
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab[role="tab"]').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
                tab.setAttribute('tabindex', '-1');
            });

            // Show selected tab and update ARIA
            document.getElementById(`${tabName}-tab`).classList.add('active');
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.setAttribute('aria-selected', 'true');
                selectedTab.setAttribute('tabindex', '0');
                selectedTab.focus();
            } else if (event) {
                event.currentTarget.classList.add('active');
            }
        }

        function handleTabKeydown(event, currentTab) {
            const currentIndex = TAB_ORDER.indexOf(currentTab);
            let newIndex = currentIndex;

            switch (event.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    event.preventDefault();
                    newIndex = currentIndex > 0 ? currentIndex - 1 : TAB_ORDER.length - 1;
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                    event.preventDefault();
                    newIndex = currentIndex < TAB_ORDER.length - 1 ? currentIndex + 1 : 0;
                    break;
                case 'Home':
                    event.preventDefault();
                    newIndex = 0;
                    break;
                case 'End':
                    event.preventDefault();
                    newIndex = TAB_ORDER.length - 1;
                    break;
                default:
                    return;
            }

            const newTab = TAB_ORDER[newIndex];
            showTab(newTab);
        }
        
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Show loading for large tables
            const showLoading = rows.length > 100;
            if (showLoading) {
                showTableLoading(tableId);
            }

            // Use requestAnimationFrame to allow UI to update
            requestAnimationFrame(() => {
                const currentSort = currentSortColumn[tableId];
                const isAscending = currentSort?.column !== columnIndex || currentSort?.direction === 'desc';

                rows.sort((a, b) => {
                    const aVal = a.children[columnIndex].textContent.trim();
                    const bVal = b.children[columnIndex].textContent.trim();

                    // Handle numeric values
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return isAscending ? aNum - bNum : bNum - aNum;
                    }

                    // Handle string values
                    return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                });

                // Update sort indicators
                table.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                });

                const targetHeader = table.querySelectorAll('th')[columnIndex];
                targetHeader.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');

                currentSortColumn[tableId] = {
                    column: columnIndex,
                    direction: isAscending ? 'asc' : 'desc'
                };

                // Re-append sorted rows
                rows.forEach(row => tbody.appendChild(row));

                if (showLoading) {
                    hideTableLoading(tableId);
                }
            });
        }
        
        function applyFilters(tableId) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');

            // Show loading for large tables
            const showLoading = rows.length > 100;
            if (showLoading) {
                showTableLoading(tableId);
            }

            // Get filter values
            const searchBox = document.getElementById('search-' + tableId.replace('-table', ''));
            const searchValue = searchBox ? searchBox.value.toLowerCase() : '';
            const layerFilter = document.getElementById('filter-layer-' + tableId.replace('-table', ''));
            const layerValue = layerFilter ? layerFilter.value : '';
            const typeFilter = document.getElementById('filter-type-' + tableId.replace('-table', ''));
            const typeValue = typeFilter ? typeFilter.value : '';

            // Use requestAnimationFrame to allow UI to update
            requestAnimationFrame(() => {
                rows.forEach(row => {
                    let show = true;

                    // Apply search filter
                    if (searchValue) {
                        const text = row.textContent.toLowerCase();
                        if (!text.includes(searchValue)) {
                            show = false;
                        }
                    }

                    // Apply layer filter
                    if (show && layerValue) {
                        if (row.getAttribute('data-layer') !== layerValue) {
                            show = false;
                        }
                    }

                    // Apply type filter
                    if (show && typeValue) {
                        if (row.getAttribute('data-type') !== typeValue) {
                            show = false;
                        }
                    }

                    row.style.display = show ? '' : 'none';
                });

                // Update filter count and hide loading
                updateFilterCount(tableId);
                if (showLoading) {
                    hideTableLoading(tableId);
                }
            });
        }

        function filterTable(tableId, searchValue) {
            applyFilters(tableId);
        }

        function filterByLayer(tableId, layer) {
            applyFilters(tableId);
        }

        function filterByType(tableId, type) {
            applyFilters(tableId);
        }
        
        function filterSubprocessorsByLayer(tableId, layer) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                if (!layer || row.getAttribute('data-layer') === layer) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterSubprocessorsByType(tableId, subprocessorType) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                if (!subprocessorType || row.getAttribute('data-subprocessor-type') === subprocessorType) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function setupTableInteractions() {
            // Add hover tooltips for table cells
            document.querySelectorAll('.data-table td').forEach(cell => {
                cell.addEventListener('mouseenter', function(e) {
                    if (this.scrollWidth > this.clientWidth) {
                        showTooltip(e, this.textContent);
                    }
                });

                cell.addEventListener('mouseleave', hideTooltip);
            });

            // Add click handlers to vendor names to focus in graph
            document.querySelectorAll('.data-table td strong').forEach(vendorName => {
                vendorName.addEventListener('click', function() {
                    const domain = this.textContent.trim();
                    focusVendorInGraph(domain);
                });
            });
        }

        function focusVendorInGraph(domain) {
            if (!window.vendorGraph) {
                alert('Graph not yet initialized. Please wait for the graph to load.');
                return;
            }

            // Scroll to graph section
            const graphContainer = document.getElementById('vendor-graph');
            if (graphContainer) {
                graphContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Wait for scroll to finish, then focus using Svelte component's method
            setTimeout(function() {
                if (window.vendorGraph && window.vendorGraph.focusNode) {
                    window.vendorGraph.focusNode(domain);
                }
            }, 500);
        }
        
        function showTooltip(event, text) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = text;
            tooltip.style.left = (event.clientX + window.scrollX + 10) + 'px';
            tooltip.style.top = (event.clientY + window.scrollY - 30) + 'px';
            tooltip.style.opacity = '1';
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.opacity = '0';
        }

        // Evidence Modal Functions - Using safe DOM methods
        function createTextElement(tag, text, className) {
            const el = document.createElement(tag);
            el.textContent = text;
            if (className) el.className = className;
            return el;
        }

        function openEvidenceModal(relationshipIndex) {
            const rel = relationshipsData[relationshipIndex];
            if (!rel) return;

            const modal = document.getElementById('evidence-modal-overlay');
            const body = document.getElementById('evidence-modal-body');

            // Clear previous content safely
            while (body.firstChild) {
                body.removeChild(body.firstChild);
            }

            // Build content using safe DOM methods
            const metaGrid = document.createElement('div');
            metaGrid.className = 'evidence-meta';

            const metaItems = [
                { label: 'Vendor Domain', value: rel.nth_party_domain },
                { label: 'Organization', value: rel.nth_party_organization },
                { label: 'Record Type', value: getReadableRecordType(rel.nth_party_record_type) },
                { label: 'Customer Domain', value: rel.nth_party_customer_domain }
            ];

            metaItems.forEach(item => {
                const metaItem = document.createElement('div');
                metaItem.className = 'evidence-meta-item';
                const label = createTextElement('div', item.label, 'evidence-meta-label');
                const value = createTextElement('div', item.value, 'evidence-meta-value');
                metaItem.appendChild(label);
                metaItem.appendChild(value);
                metaGrid.appendChild(metaItem);
            });
            body.appendChild(metaGrid);

            // Evidence section
            const evidenceSection = document.createElement('div');
            evidenceSection.className = 'evidence-section';
            const evidenceTitle = createTextElement('div', 'üìã Full Evidence', 'evidence-section-title');
            const evidenceContent = createTextElement('div', rel.evidence, 'evidence-content');
            evidenceSection.appendChild(evidenceTitle);
            evidenceSection.appendChild(evidenceContent);
            body.appendChild(evidenceSection);

            // Record value section
            const recordSection = document.createElement('div');
            recordSection.className = 'evidence-section';
            const recordTitle = createTextElement('div', 'üìÑ Record Value', 'evidence-section-title');
            const recordContent = createTextElement('div', rel.nth_party_record, 'evidence-content');
            recordSection.appendChild(recordTitle);
            recordSection.appendChild(recordContent);
            body.appendChild(recordSection);

            // Validation section
            const validationSection = document.createElement('div');
            validationSection.className = 'validation-section';
            const validationTitle = createTextElement('div', 'üîç Validate This Evidence', 'evidence-section-title');
            validationSection.appendChild(validationTitle);

            const validationDesc = createTextElement('p', 'Verify this finding yourself using the commands below. Select your platform:');
            validationDesc.style.cssText = 'margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;';
            validationSection.appendChild(validationDesc);

            // Tabs
            const tabsContainer = document.createElement('div');
            tabsContainer.className = 'validation-tabs';

            const platforms = [
                { id: 'browser', icon: 'üåê', label: 'Browser', active: true },
                { id: 'macos', icon: 'üçé', label: 'macOS', active: false },
                { id: 'windows', icon: 'ü™ü', label: 'Windows', active: false },
                { id: 'linux', icon: 'üêß', label: 'Linux', active: false }
            ];

            platforms.forEach(platform => {
                const tab = document.createElement('button');
                tab.className = 'validation-tab' + (platform.active ? ' active' : '');
                tab.onclick = function() { showValidationTab(this, platform.id + '-' + relationshipIndex); };
                const iconSpan = createTextElement('span', platform.icon, 'validation-tab-icon');
                tab.appendChild(iconSpan);
                tab.appendChild(document.createTextNode(' ' + platform.label));
                tabsContainer.appendChild(tab);
            });
            validationSection.appendChild(tabsContainer);

            // Generate and add command containers
            const commands = generateValidationCommands(rel, relationshipIndex);
            platforms.forEach(platform => {
                const contentDiv = document.createElement('div');
                contentDiv.id = platform.id + '-' + relationshipIndex;
                contentDiv.className = 'validation-content';
                contentDiv.style.display = platform.active ? 'block' : 'none';
                contentDiv.appendChild(commands[platform.id]);
                validationSection.appendChild(contentDiv);
            });

            body.appendChild(validationSection);

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeEvidenceModal() {
            const modal = document.getElementById('evidence-modal-overlay');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function showValidationTab(button, tabId) {
            const tabs = button.parentElement.querySelectorAll('.validation-tab');
            tabs.forEach(t => t.classList.remove('active'));
            button.classList.add('active');

            const section = button.closest('.validation-section');
            const contents = section.querySelectorAll('.validation-content');
            contents.forEach(c => c.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
        }

        function getReadableRecordType(type) {
            const types = {
                'DnsTxtSpf': 'Email Provider (SPF)',
                'DnsTxtVerification': 'Domain Verification',
                'DnsTxtDmarc': 'Email Security (DMARC)',
                'DnsTxtDkim': 'Email Security (DKIM)',
                'DnsSubdomain': 'Subdomain',
                'DnsCname': 'CNAME Record',
                'DnsMx': 'Mail Server (MX)',
                'HttpSubprocessor': 'Subprocessor Page',
                'SubfinderDiscovery': 'Subdomain Discovery',
                'SaasTenantProbe': 'SaaS Tenant',
                'DNS::TXT::SPF': 'Email Provider (SPF)',
                'DNS::TXT::VERIFICATION': 'Domain Verification',
                'DNS::TXT::DMARC': 'Email Security (DMARC)',
                'DNS::SUBDOMAIN': 'Subdomain',
                'DNS::CNAME': 'CNAME Record',
                'HTTP::SUBPROCESSOR': 'Subprocessor Page',
                'DISCOVERY::SUBFINDER': 'Subdomain Discovery',
                'DISCOVERY::SAAS_TENANT': 'SaaS Tenant'
            };
            return types[type] || type;
        }

        function createCommandContainer(labelText, command, explanation) {
            const container = document.createElement('div');
            container.className = 'validation-command-container';

            const header = document.createElement('div');
            header.className = 'validation-command-header';

            const label = createTextElement('span', labelText, 'validation-command-label');
            header.appendChild(label);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'validation-copy-btn';
            copyBtn.textContent = 'üìã Copy';
            copyBtn.onclick = function() { copyCommand(this); };
            header.appendChild(copyBtn);

            container.appendChild(header);

            const codeDiv = createTextElement('div', command, 'validation-command-code');
            container.appendChild(codeDiv);

            if (explanation) {
                const explDiv = document.createElement('div');
                explDiv.className = 'validation-explanation';
                const strong = document.createElement('strong');
                strong.textContent = 'How it works: ';
                explDiv.appendChild(strong);
                explDiv.appendChild(document.createTextNode(explanation));
                container.appendChild(explDiv);
            }

            return container;
        }

        function createBrowserValidation(domain, searchPattern, isSubprocessor, subprocessorUrl, orgName) {
            const container = document.createElement('div');
            container.className = 'browser-validation';

            const title = document.createElement('div');
            title.className = 'browser-validation-title';
            title.textContent = 'üåê Validate in Browser';

            if (!isSubprocessor) {
                const inspectBtn = document.createElement('button');
                inspectBtn.className = 'inspect-code-btn';
                inspectBtn.textContent = 'Inspect Code';
                inspectBtn.onclick = function() { toggleInspectCode(this); };
                title.appendChild(inspectBtn);
            }
            container.appendChild(title);

            const desc = document.createElement('p');
            desc.style.cssText = 'color: #92400e; font-size: 0.875rem; margin-bottom: 0.75rem;';

            if (isSubprocessor) {
                desc.textContent = 'Visit the subprocessor page directly to verify ' + domain + ' is listed:';
                container.appendChild(desc);

                if (subprocessorUrl) {
                    const link = document.createElement('a');
                    link.href = subprocessorUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.className = 'browser-validation-btn';
                    link.style.cssText = 'text-decoration: none; display: inline-block;';
                    link.textContent = 'üîó Open Subprocessor Page';
                    container.appendChild(link);
                } else {
                    const noUrl = createTextElement('p', 'No URL found in evidence.');
                    noUrl.style.color = '#dc2626';
                    container.appendChild(noUrl);
                }

                const tip = document.createElement('p');
                tip.style.cssText = 'color: #92400e; font-size: 0.8rem; margin-top: 0.75rem;';
                tip.textContent = 'üí° Search for "' + orgName + '" on the page to find this vendor.';
                container.appendChild(tip);
            } else {
                desc.textContent = 'Click the button below to query DNS TXT records for ' + domain + ' directly from this page.';
                container.appendChild(desc);

                const runBtn = document.createElement('button');
                runBtn.className = 'browser-validation-btn';
                runBtn.textContent = 'üîç Run DNS Lookup';
                runBtn.onclick = function() { runBrowserDnsLookup(domain, searchPattern, this); };
                container.appendChild(runBtn);

                const codeBlock = document.createElement('div');
                codeBlock.className = 'browser-validation-code';
                codeBlock.textContent = '// This code uses Google\'s DNS-over-HTTPS API\nasync function lookupDnsTxt(domain) {\n    const response = await fetch(\n        `https://dns.google/resolve?name=${domain}&type=TXT`\n    );\n    const data = await response.json();\n    return data.Answer || [];\n}';
                container.appendChild(codeBlock);

                const resultDiv = document.createElement('div');
                resultDiv.className = 'browser-validation-result';
                resultDiv.style.display = 'none';
                container.appendChild(resultDiv);
            }

            return container;
        }

        function generateValidationCommands(rel, relationshipIndex) {
            const domain = rel.nth_party_customer_domain;
            const recordType = rel.nth_party_record_type;
            const record = rel.nth_party_record;
            const evidence = rel.evidence;

            const isSpf = recordType === 'DnsTxtSpf' || recordType === 'DNS::TXT::SPF';
            const isVerification = recordType === 'DnsTxtVerification' || recordType === 'DNS::TXT::VERIFICATION';
            const isSubprocessor = recordType === 'HttpSubprocessor' || recordType === 'HTTP::SUBPROCESSOR';
            const isDmarc = recordType === 'DnsTxtDmarc' || recordType === 'DNS::TXT::DMARC';
            const isCname = recordType === 'DnsCname' || recordType === 'DNS::CNAME';
            const isSubfinder = recordType === 'SubfinderDiscovery' || recordType === 'DISCOVERY::SUBFINDER';
            const isSaasTenant = recordType === 'SaasTenantProbe' || recordType === 'DISCOVERY::SAAS_TENANT';

            let commands = {};

            // Determine the appropriate search pattern based on record type
            let searchPattern;
            if (isVerification) {
                // For Domain Verification records, extract the vendor name prefix
                // e.g., "jetbrains-domain-verification=xxx" -> "jetbrains"
                // or "google-site-verification=xxx" -> "google"
                // The record field might contain the derived domain (e.g., "jetbrains.com")
                // So we also try to extract from the evidence or vendor domain
                const vendorDomain = rel.nth_party_domain;
                // Extract the base vendor name (without TLD) - e.g., "jetbrains.com" -> "jetbrains"
                const vendorBase = vendorDomain.split('.')[0];
                // Try to find the verification record pattern in the evidence
                const verificationMatch = evidence.match(/([a-z0-9-]+)[-_](?:domain|site|ownership)?[-_]?verification/i);
                if (verificationMatch) {
                    searchPattern = verificationMatch[1]; // e.g., "jetbrains" from "jetbrains-domain-verification"
                } else {
                    // Fall back to vendor base name
                    searchPattern = vendorBase;
                }
            } else {
                // For SPF, DMARC, and other records, use the record content
                searchPattern = record.substring(0, Math.min(50, record.length));
            }

            const grepExplanation = 'dig TXT queries DNS TXT records, +short gives concise output, and grep -i does case-insensitive pattern matching.';

            if (isSpf || isVerification || isDmarc) {
                commands.browser = createBrowserValidation(domain, searchPattern, false, null, null);
                commands.macos = createCommandContainer(
                    'Terminal Command',
                    'dig TXT ' + domain + ' +short | grep -i "' + searchPattern + '"',
                    grepExplanation
                );
                commands.windows = createCommandContainer(
                    'PowerShell Command',
                    'Resolve-DnsName -Name ' + domain + ' -Type TXT | Select-Object -ExpandProperty Strings | Select-String "' + searchPattern + '"',
                    'Resolve-DnsName queries DNS, -Type TXT gets TXT records, and Select-String filters for the pattern.'
                );
                commands.linux = createCommandContainer(
                    'Terminal Command',
                    'dig TXT ' + domain + ' +short | grep -i "' + searchPattern + '"',
                    grepExplanation
                );
            } else if (isSubprocessor) {
                const urlMatch = evidence.match(/https?:\/\/[^\s)]+/);
                const subprocessorUrl = urlMatch ? urlMatch[0] : '';
                const curlCommand = 'curl -s "' + (subprocessorUrl || 'URL_HERE') + '" | grep -i "' + rel.nth_party_organization + '"';
                const curlExplanation = 'curl -s fetches the page silently, and grep -i searches for the organization name (case-insensitive).';

                commands.browser = createBrowserValidation(rel.nth_party_domain, null, true, subprocessorUrl, rel.nth_party_organization);
                commands.macos = createCommandContainer(
                    'Terminal Command',
                    curlCommand,
                    curlExplanation
                );
                commands.windows = createCommandContainer(
                    'PowerShell Command',
                    '(Invoke-WebRequest -Uri "' + (subprocessorUrl || 'URL_HERE') + '").Content | Select-String "' + rel.nth_party_organization + '"',
                    'Invoke-WebRequest fetches the webpage, and Select-String searches for the organization name.'
                );
                commands.linux = createCommandContainer(
                    'Terminal Command',
                    curlCommand,
                    curlExplanation
                );
            } else if (isCname) {
                // CNAME discovery - validate the CNAME chain
                const subdomainMatch = evidence.match(/Subdomain\s+([^\s]+)\s+CNAMEs\s+to\s+([^\s(]+)/);
                const subdomain = subdomainMatch ? subdomainMatch[1] : domain;
                const cnameTarget = subdomainMatch ? subdomainMatch[2] : rel.nth_party_domain;

                const cnameDiv = document.createElement('div');
                cnameDiv.className = 'browser-validation';
                const cnameTitle = createTextElement('div', 'üîó CNAME Infrastructure Validation', 'browser-validation-title');
                cnameDiv.appendChild(cnameTitle);
                const cnameDesc = createTextElement('p', 'This vendor was discovered via CNAME record analysis. The subdomain "' + subdomain + '" has a CNAME pointing to "' + cnameTarget + '", indicating third-party infrastructure.');
                cnameDesc.style.cssText = 'color: #6b7280; font-size: 0.875rem;';
                cnameDiv.appendChild(cnameDesc);
                commands.browser = cnameDiv;

                const cnameCommand = 'dig CNAME ' + subdomain + ' +short';
                const cnameExplanation = 'Query the CNAME record to verify the subdomain points to third-party infrastructure.';
                commands.macos = createCommandContainer(
                    'Terminal Command',
                    cnameCommand,
                    cnameExplanation
                );
                commands.windows = createCommandContainer(
                    'PowerShell Command',
                    'Resolve-DnsName -Name ' + subdomain + ' -Type CNAME',
                    'Resolve the CNAME record to verify the third-party infrastructure relationship.'
                );
                commands.linux = createCommandContainer(
                    'Terminal Command',
                    cnameCommand,
                    cnameExplanation
                );
            } else if (isSubfinder) {
                // Subdomain discovery - validate the subdomain exists
                const subdomainMatch = evidence.match(/Subdomain:\s*([^\s(]+)/);
                const subdomain = subdomainMatch ? subdomainMatch[1] : rel.nth_party_domain;

                const subfinderDiv = document.createElement('div');
                subfinderDiv.className = 'browser-validation';
                const subfinderTitle = createTextElement('div', 'üîç Subdomain Discovery Validation', 'browser-validation-title');
                subfinderDiv.appendChild(subfinderTitle);
                const subfinderDesc = createTextElement('p', 'This vendor was discovered via subdomain enumeration. The subdomain "' + subdomain + '" points to or is hosted by this vendor.');
                subfinderDesc.style.cssText = 'color: #6b7280; font-size: 0.875rem;';
                subfinderDiv.appendChild(subfinderDesc);
                commands.browser = subfinderDiv;

                const subfinderCommand = 'dig ' + subdomain + ' +short && dig ' + rel.nth_party_domain + ' +short';
                const subfinderExplanation = 'Resolve the subdomain and vendor domain to verify the relationship.';
                commands.macos = createCommandContainer(
                    'Terminal Command',
                    subfinderCommand,
                    subfinderExplanation
                );
                commands.windows = createCommandContainer(
                    'PowerShell Command',
                    'Resolve-DnsName -Name ' + subdomain + '; Resolve-DnsName -Name ' + rel.nth_party_domain,
                    'Resolve both the subdomain and vendor domain to verify they are related.'
                );
                commands.linux = createCommandContainer(
                    'Terminal Command',
                    subfinderCommand,
                    subfinderExplanation
                );
            } else if (isSaasTenant) {
                // SaaS tenant discovery - validate the tenant URL
                const tenantUrlMatch = evidence.match(/Tenant URL:\s*([^\s(]+)/);
                const tenantUrl = tenantUrlMatch ? tenantUrlMatch[1] : '';

                const tenantDiv = document.createElement('div');
                tenantDiv.className = 'browser-validation';
                const tenantTitle = createTextElement('div', 'üè¢ SaaS Tenant Discovery Validation', 'browser-validation-title');
                tenantDiv.appendChild(tenantTitle);
                const tenantDesc = createTextElement('p', 'This vendor was discovered by probing SaaS tenant URLs. Visit the tenant URL to verify the organization uses this service.');
                tenantDesc.style.cssText = 'color: #6b7280; font-size: 0.875rem;';
                tenantDiv.appendChild(tenantDesc);
                if (tenantUrl) {
                    const tenantLink = document.createElement('a');
                    tenantLink.href = tenantUrl;
                    tenantLink.target = '_blank';
                    tenantLink.textContent = tenantUrl;
                    tenantLink.style.cssText = 'color: #3b82f6; text-decoration: underline; word-break: break-all;';
                    tenantDiv.appendChild(tenantLink);
                }
                commands.browser = tenantDiv;

                const tenantCommand = 'curl -sI "' + (tenantUrl || 'TENANT_URL_HERE') + '" | head -20';
                const tenantExplanation = 'Fetch HTTP headers from the tenant URL to verify it exists and responds.';
                commands.macos = createCommandContainer(
                    'Terminal Command',
                    tenantCommand,
                    tenantExplanation
                );
                commands.windows = createCommandContainer(
                    'PowerShell Command',
                    'Invoke-WebRequest -Uri "' + (tenantUrl || 'TENANT_URL_HERE') + '" -Method Head | Select-Object StatusCode, StatusDescription',
                    'Send a HEAD request to verify the tenant URL exists.'
                );
                commands.linux = createCommandContainer(
                    'Terminal Command',
                    tenantCommand,
                    tenantExplanation
                );
            } else {
                const manualDiv = document.createElement('div');
                manualDiv.className = 'browser-validation';
                const manualTitle = createTextElement('div', 'üåê Manual Validation Required', 'browser-validation-title');
                manualDiv.appendChild(manualTitle);
                const manualDesc = createTextElement('p', 'This record type (' + getReadableRecordType(recordType) + ') requires manual investigation. Review the evidence and record value above.');
                manualDesc.style.cssText = 'color: #92400e; font-size: 0.875rem;';
                manualDiv.appendChild(manualDesc);
                commands.browser = manualDiv;

                const genericCmd = createCommandContainer(
                    'General DNS Lookup',
                    'dig ANY ' + domain + ' +short',
                    'Query all DNS records for the domain to investigate.'
                );
                commands.macos = genericCmd;
                commands.windows = createCommandContainer(
                    'PowerShell Command',
                    'Resolve-DnsName -Name ' + domain,
                    'Query DNS records for the domain.'
                );
                commands.linux = genericCmd.cloneNode(true);
            }

            return commands;
        }

        async function runBrowserDnsLookup(domain, searchPattern, button) {
            const container = button.closest('.browser-validation');
            const resultDiv = container.querySelector('.browser-validation-result');

            button.disabled = true;
            button.textContent = '‚è≥ Looking up...';
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Querying DNS records...';

            try {
                const response = await fetch('https://dns.google/resolve?name=' + encodeURIComponent(domain) + '&type=TXT');
                const data = await response.json();

                // Clear result div safely
                while (resultDiv.firstChild) {
                    resultDiv.removeChild(resultDiv.firstChild);
                }

                if (data.Answer && data.Answer.length > 0) {
                    const matchingRecords = data.Answer.filter(r =>
                        r.data.toLowerCase().includes(searchPattern.toLowerCase())
                    );

                    if (matchingRecords.length > 0) {
                        const successMsg = createTextElement('p', '‚úÖ Record Found!');
                        successMsg.style.cssText = 'color: #16a34a; font-weight: 600; margin-bottom: 0.5rem;';
                        resultDiv.appendChild(successMsg);

                        const matchLabel = createTextElement('p', 'Matching records:');
                        matchLabel.style.cssText = 'font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;';
                        resultDiv.appendChild(matchLabel);

                        const pre = document.createElement('pre');
                        pre.style.cssText = 'background: #f0fdf4; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; overflow-x: auto;';
                        pre.textContent = matchingRecords.map(r => r.data).join('\n');
                        resultDiv.appendChild(pre);

                        const countMsg = createTextElement('p', 'Found ' + data.Answer.length + ' total TXT record(s)');
                        countMsg.style.cssText = 'font-size: 0.75rem; color: #666; margin-top: 0.5rem;';
                        resultDiv.appendChild(countMsg);
                    } else {
                        const warnMsg = createTextElement('p', '‚ö†Ô∏è Pattern Not Found');
                        warnMsg.style.cssText = 'color: #d97706; font-weight: 600; margin-bottom: 0.5rem;';
                        resultDiv.appendChild(warnMsg);

                        const allLabel = createTextElement('p', 'The specific pattern wasn\'t found, but here are all TXT records:');
                        allLabel.style.cssText = 'font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;';
                        resultDiv.appendChild(allLabel);

                        const pre = document.createElement('pre');
                        pre.style.cssText = 'background: #fffbeb; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; overflow-x: auto; max-height: 150px;';
                        pre.textContent = data.Answer.map(r => r.data).join('\n');
                        resultDiv.appendChild(pre);
                    }
                } else {
                    const errorMsg = createTextElement('p', '‚ùå No TXT Records Found');
                    errorMsg.style.cssText = 'color: #dc2626; font-weight: 600;';
                    resultDiv.appendChild(errorMsg);

                    const errorDesc = createTextElement('p', 'No DNS TXT records were returned for this domain.');
                    errorDesc.style.cssText = 'font-size: 0.8rem; color: #666;';
                    resultDiv.appendChild(errorDesc);
                }
            } catch (error) {
                while (resultDiv.firstChild) {
                    resultDiv.removeChild(resultDiv.firstChild);
                }

                const errorMsg = createTextElement('p', '‚ùå Lookup Failed');
                errorMsg.style.cssText = 'color: #dc2626; font-weight: 600;';
                resultDiv.appendChild(errorMsg);

                const errorDesc = createTextElement('p', error.message);
                errorDesc.style.cssText = 'font-size: 0.8rem; color: #666;';
                resultDiv.appendChild(errorDesc);

                const fallback = createTextElement('p', 'Try using the terminal commands instead.');
                fallback.style.cssText = 'font-size: 0.75rem; color: #666; margin-top: 0.5rem;';
                resultDiv.appendChild(fallback);
            }

            button.disabled = false;
            button.textContent = 'üîç Run DNS Lookup Again';
        }

        function toggleInspectCode(button) {
            const codeBlock = button.closest('.browser-validation').querySelector('.browser-validation-code');
            codeBlock.classList.toggle('visible');
            button.textContent = codeBlock.classList.contains('visible') ? 'Hide Code' : 'Inspect Code';
        }

        function copyCommand(button) {
            const container = button.closest('.validation-command-container');
            const code = container.querySelector('.validation-command-code').textContent.trim();

            navigator.clipboard.writeText(code).then(function() {
                button.classList.add('copied');
                button.textContent = '‚úÖ Copied!';
                setTimeout(function() {
                    button.classList.remove('copied');
                    button.textContent = 'üìã Copy';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy:', err);
                button.textContent = '‚ùå Failed';
            });
        }

        // Close modal on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('evidence-modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeEvidenceModal();
                    }
                });
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEvidenceModal();
            }
        });
    </script>

    <!-- XYFlow Svelte Vendor Graph Bundle -->
    <script>{{ vendor_graph_js|safe }}</script>

    <!-- Evidence Modal -->
    <div id="evidence-modal-overlay" class="evidence-modal-overlay">
        <div class="evidence-modal">
            <div class="evidence-modal-header">
                <div class="evidence-modal-title">üîç Evidence Details</div>
                <button class="evidence-modal-close" onclick="closeEvidenceModal()">‚úï</button>
            </div>
            <div class="evidence-modal-body" id="evidence-modal-body">
                <!-- Content populated by JavaScript using safe DOM methods -->
            </div>
        </div>
    </div>
</body>
</html>